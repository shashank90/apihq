## http://test.apihome.io redirects to https://test.apihome.io
server {
    listen 80;
    listen [::]:80;
    server_name test.apihome.io;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

	location / {
		return 301 https://test.apihome.io$request_uri;
	}
}

## http://www.test.apihome.io redirects to https://www.test.apihome.io
server {
	listen 80 default_server;
	listen [::]:80 default_server ipv6only=on;
	server_name www.test.apihome.io;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

	location / {
		return 301 https://www.test.apihome.io$request_uri;
	}
}

## https://test.apihome.io redirects to https://www.test.apihome.io
server {
	listen 443 ssl http2;
	listen [::]:443 ssl http2;
	server_name test.apihome.io;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

	ssl_certificate /etc/nginx/ssl/live/test.apihome.io/fullchain.pem;
	ssl_certificate_key /etc/nginx/ssl/live/test.apihome.io/privkey.pem;
	ssl_trusted_certificate /etc/nginx/ssl/live/test.apihome.io/fullchain.pem;
	
    include /etc/nginx/snippets/ssl.conf;

	location / {
		return 301 https://www.test.apihome.io$request_uri;
	}
}

## Serves https://www.test.apihome.io
server {
	listen 443 ssl http2 default_server;
	listen [::]:443 ssl http2 default_server ipv6only=on;
	server_name www.test.apihome.io;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

	ssl_certificate /etc/nginx/ssl/live/www.test.apihome.io/fullchain.pem;
	ssl_certificate_key /etc/nginx/ssl/live/www.test.apihome.io/privkey.pem;
	ssl_trusted_certificate /etc/nginx/ssl/live/www.test.apihome.io/fullchain.pem;
	
    include /etc/nginx/snippets/ssl.conf;

    root /usr/share/nginx/html;
    index index.html;

	location / {
		try_files $uri $uri/ =404;
	}
    
    location /static {
        expires 1y;
        add_header Cache-Control "public";
    }

    location /signup {
        include proxy_params;
        proxy_pass http://backend:5000;
    }

    location /login {
        include proxy_params;
        proxy_pass http://backend:5000;
    }

    location /apis {
        include proxy_params;
        proxy_pass http://backend:5000;
    }
}


## Note that http://test.apihome.io redirects to https://test.apihome.io (which redirects to https://www.test.apihome.io) because 
## redirecting to https://www.test.apihome.io directly would be incompatible with HSTS.